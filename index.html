<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Trading BTC/USDT</title>
    <!-- Carga de Tailwind CSS para el estilo moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de React, ReactDOM y Babel para ejecutar JSX en el navegador -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Carga de la librería Lucide para los íconos (Refresh, Alert, etc.) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Asegura que la aplicación ocupe toda la pantalla del móvil */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        #root {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background-color: #111827; /* bg-gray-900 */
            padding-top: 1.5rem; /* p-6 */
        }
        /* Estilo para los inputs para mejorar la experiencia móvil */
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;
    const { RefreshCw, TrendingUp, TrendingDown, AlertTriangle } = lucide; // Extrae íconos de lucide

    // ==============================================================================
    // CONFIGURACIÓN DEL MONITOR
    // ==============================================================================
    const SYMBOL = 'BTCUSDT';
    const BINANCE_API_URL = `https://api.binance.com/api/v3/ticker/price?symbol=${SYMBOL}`;
    const UPDATE_INTERVAL_MS = 300000; // 5 minutos
    const CURRENCY_NAME = "Bitcoin (BTC/USDT)";

    const LONG_COLOR_CLASS = 'text-amber-400';
    const SHORT_COLOR_CLASS = 'text-red-500';
    const DEFAULT_COLOR_CLASS = 'text-gray-300';
    
    // Función de utilería para el formateo de números en español
    const formatNumber = (num) => {
        if (num === null) return '---';
        return `$${num.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    };

    /**
     * Componente de entrada para los precios de alerta.
     */
    const AlertInput = ({ label, value, onChange, colorClass }) => (
      <div className="flex flex-col items-center p-2 bg-gray-700/50 rounded-lg shadow-inner flex-grow">
        <label className="text-xs font-medium text-gray-400">{label}</label>
        <div className="flex items-center mt-1">
          <span className="text-lg font-bold text-gray-500 mr-1">$</span>
          <input
            type="number"
            value={value}
            onChange={onChange}
            min="0"
            step="100"
            className={`w-28 text-center text-lg font-mono bg-transparent border-b-2 ${colorClass} focus:outline-none focus:border-opacity-100 border-opacity-30 transition-colors`}
            aria-label={`Precio objetivo para ${label}`}
          />
        </div>
      </div>
    );

    /**
     * Componente principal de la aplicación.
     */
    const App = () => {
      const [currentPrice, setCurrentPrice] = useState(null);
      const [lastUpdated, setLastUpdated] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      
      // Estados para los precios objetivo (se pueden modificar en la UI)
      const [longPrice, setLongPrice] = useState(93000.0);
      const [shortPrice, setShortPrice] = useState(96000.0);
      const [alertThreshold, setAlertThreshold] = useState(100.0);
      
      const MAX_RETRIES = 5;
      const initialDelay = 1000; // 1 second

      // Función para obtener el precio de Binance con reintento exponencial
      const fetchPrice = useCallback(async (retryCount = 0) => {
        if (retryCount === 0) {
            setLoading(true);
            setError(null);
        }

        try {
          const response = await fetch(BINANCE_API_URL, { signal: AbortSignal.timeout(10000) });
          if (!response.ok) {
            throw new Error(`Error en la API: ${response.statusText}`);
          }
          const data = await response.json();
          const price = parseFloat(data.price);
          
          setCurrentPrice(price);
          setLastUpdated(new Date());

        } catch (e) {
          console.error("Error fetching price:", e);
          
          if (retryCount < MAX_RETRIES) {
              const delay = initialDelay * Math.pow(2, retryCount);
              // console.log(`Reintentando en ${delay}ms...`);
              await new Promise(resolve => setTimeout(resolve, delay));
              fetchPrice(retryCount + 1);
          } else {
              setError("Error de conexión o de la API. No se pudo obtener el precio después de varios reintentos.");
          }
        } finally {
          if (retryCount === 0 || retryCount === MAX_RETRIES) {
              setLoading(false);
          }
        }
      }, []);

      // Hook para el ciclo de vida y la actualización automática
      useEffect(() => {
        // 1. Cargar el precio inmediatamente al iniciar
        fetchPrice();
        
        // 2. Configurar el intervalo de actualización
        const intervalId = setInterval(fetchPrice, UPDATE_INTERVAL_MS);

        // Limpiar el intervalo al desmontar el componente
        return () => clearInterval(intervalId);
      }, [fetchPrice]);

      // Cálculo de alertas y porcentajes usando useMemo para optimización
      const analysis = useMemo(() => {
        if (currentPrice === null) {
          return {};
        }

        // ---------------------------------------------
        // CÁLCULO DE PORCENTAJES
        // ---------------------------------------------
        
        // Short (Venta)
        const shortDiffUsd = shortPrice - currentPrice;
        const shortPercent = (shortDiffUsd / currentPrice) * 100;
        
        // Long (Compra)
        const longDiffUsd = longPrice - currentPrice;
        const longPercent = (longDiffUsd / currentPrice) * 100;
        
        // ---------------------------------------------
        // LÓGICA DE ALERTA (PROXIMIDAD Y CRUCE)
        // ---------------------------------------------

        // 1. Alerta de Venta (Short): Precio cerca o por encima del objetivo.
        const isShortAlert = (
          currentPrice >= shortPrice || 
          (shortPrice - alertThreshold <= currentPrice && currentPrice < shortPrice)
        );

        // 2. Alerta de Compra (Long): Precio cerca o por debajo del objetivo.
        const isLongAlert = (
          currentPrice <= longPrice ||
          (longPrice < currentPrice && currentPrice <= longPrice + alertThreshold)
        );

        return {
          shortPercent: shortPercent,
          longPercent: longPercent,
          isShortAlert: isShortAlert,
          isLongAlert: isLongAlert,
          shortColor: isShortAlert ? SHORT_COLOR_CLASS : DEFAULT_COLOR_CLASS,
          longColor: isLongAlert ? LONG_COLOR_CLASS : DEFAULT_COLOR_CLASS,
        };
      }, [currentPrice, shortPrice, longPrice, alertThreshold]);
      
      // Manejadores de cambio para los inputs
      const handleLongChange = (e) => setLongPrice(parseFloat(e.target.value) || 0);
      const handleShortChange = (e) => setShortPrice(parseFloat(e.target.value) || 0);
      const handleThresholdChange = (e) => setAlertThreshold(parseFloat(e.target.value) || 0);

      return (
        <div className="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-4 md:p-6 space-y-6">
          
          {/* Encabezado y Título */}
          <div className="flex justify-between items-center border-b border-gray-700 pb-3">
            <h1 className="text-xl font-bold text-gray-100">
              Monitor de Trading V1
            </h1>
            <button 
              onClick={() => fetchPrice()} // Llamada sin argumentos para el reintento
              disabled={loading}
              className="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors disabled:opacity-50"
              aria-label="Actualizar precio ahora"
            >
              <RefreshCw size={18} className={loading ? 'animate-spin text-blue-400' : 'text-gray-400'} />
            </button>
          </div>

          {/* Display del Precio Actual */}
          <div className="bg-gray-700 p-4 rounded-xl shadow-lg text-center">
            <p className="text-sm text-gray-400 font-medium">{CURRENCY_NAME}</p>
            <h2 className="text-5xl font-extrabold mt-1 tracking-tight">
              {formatNumber(currentPrice)}
            </h2>
            {lastUpdated && (
              <p className="text-xs text-gray-500 mt-2">
                Actualizado: {lastUpdated.toLocaleTimeString('es-AR')}
              </p>
            )}
            {error && <p className="text-red-400 text-sm mt-2">{error}</p>}
            {loading && !error && (
                <p className="text-blue-400 text-sm mt-2">Cargando precio...</p>
            )}
          </div>

          {/* Input de Precios Objetivo */}
          <div className="flex justify-between space-x-3">
            <AlertInput 
              label="Precio Long (Compra)" 
              value={longPrice} 
              onChange={handleLongChange} 
              colorClass={LONG_COLOR_CLASS}
            />
            <AlertInput 
              label="Precio Short (Venta)" 
              value={shortPrice} 
              onChange={handleShortChange} 
              colorClass={SHORT_COLOR_CLASS}
            />
          </div>
          
          {/* Input de Umbral de Proximidad */}
          <div className="flex justify-center">
              <label className="text-xs text-gray-400 mr-2 self-center">Umbral Alerta ($)</label>
              <input
                  type="number"
                  value={alertThreshold}
                  onChange={handleThresholdChange}
                  min="0"
                  step="10"
                  className="w-20 text-center text-sm font-mono bg-gray-700/50 border-b-2 border-gray-600 rounded-md p-1 focus:outline-none focus:border-blue-400 transition-colors"
                  aria-label="Umbral de proximidad para alertas"
              />
          </div>


          {/* Display de Porcentajes y Alertas */}
          {currentPrice !== null && (
            <div className="space-y-3 pt-3 border-t border-gray-700">
              {/* Alerta de Venta (Short) */}
              <div className={`p-3 rounded-xl shadow-md transition-all ${analysis.isShortAlert ? 'bg-red-900/40 border border-red-500' : 'bg-gray-700'}`}>
                <div className="flex justify-between items-center">
                  <div className="flex items-center space-x-2">
                    <TrendingUp size={20} className={analysis.shortColor} />
                    <span className={`font-semibold ${analysis.shortColor}`}>
                      Venta Short @ {formatNumber(shortPrice).replace('$', '')}
                    </span>
                  </div>
                  <span className={`text-xl font-mono font-bold ${analysis.shortColor}`}>
                    {analysis.shortPercent > 0 ? `+${analysis.shortPercent.toFixed(2)}%` : `${analysis.shortPercent.toFixed(2)}%`}
                  </span>
                </div>
                {analysis.isShortAlert && (
                  <div className="mt-2 flex items-center text-red-400 text-sm font-bold">
                    <AlertTriangle size={16} className="mr-2" />
                    ¡ALERTA! Posible Venta en Short
                  </div>
                )}
              </div>

              {/* Alerta de Compra (Long) */}
              <div className={`p-3 rounded-xl shadow-md transition-all ${analysis.isLongAlert ? 'bg-amber-900/40 border border-amber-400' : 'bg-gray-700'}`}>
                <div className="flex justify-between items-center">
                  <div className="flex items-center space-x-2">
                    <TrendingDown size={20} className={analysis.longColor} />
                    <span className={`font-semibold ${analysis.longColor}`}>
                      Compra Long @ {formatNumber(longPrice).replace('$', '')}
                    </span>
                  </div>
                  <span className={`text-xl font-mono font-bold ${analysis.longColor}`}>
                    {analysis.longPercent > 0 ? `+${analysis.longPercent.toFixed(2)}%` : `${analysis.longPercent.toFixed(2)}%`}
                  </span>
                </div>
                {analysis.isLongAlert && (
                  <div className="mt-2 flex items-center text-amber-400 text-sm font-bold">
                    <AlertTriangle size={16} className="mr-2" />
                    ¡ALERTA! Posible Compra en Long
                  </div>
                )}
              </div>
            </div>
          )}
          
        </div>
        
        {/* Footer de información */}
        <footer className="mt-6 text-xs text-gray-500 max-w-md text-center fixed bottom-0 left-0 right-0 p-4 bg-gray-900/80 backdrop-blur-sm">
          Fuente de datos: Binance API pública. Próxima actualización en: {(UPDATE_INTERVAL_MS / 1000 / 60).toFixed(0)} minutos.
        </footer>
      );
    };

    // Inicialización de la aplicación React
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
</script>

</body>
</html>
